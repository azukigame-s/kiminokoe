# Claude Code 引継ぎ指示文

## 📚 まず読んでください

このプロジェクトは「キミノコエ」という感動系ビジュアルノベルゲームです。 

以下のドキュメントを順番に読んでから作業を開始してください。

### 必読ドキュメント（優先順）

1. **`project_overview.md`**
   - ゲーム全体の仕様書
   - ストーリー、キャラクター、技術仕様が全て記載されています
   - **最重要**: これを読まずに作業しないでください
2. **`scenarios.md`**
   - シナリオの原稿（マークダウン形式）
   - JSON変換前のマスターデータです
   - シナリオの内容確認はこちらを参照してください

------

## 🎯 現在の作業状況（2026年2月8日時点）

### ✅ 完成済み

#### シナリオ（scenarios.md）

- **プロローグ**: 完成
- **10月10日**: 完成
  - 1枠目: 北・東・南・西すべて完成
  - 2枠目: すべて完成
  - 地蔵の配置: 完了（各ルートに配置済み）
  - **夕食シーン（19:00）**: 完成
  - **体験版エンディング（21:00〜22:00）**: 完成
- **10月11日**: 完成（法事シーン）
- **エピソード**: ep_0, ep_0_β, ep_1〜ep_7 すべて完成

#### 共用シナリオ（shared）

- `shared_day_1010_c`: 海水浴場（ep_2 + 霊体描写）
- `shared_ep_3_after`: バス停の後（霊体描写 + イロが迎えに来る）
- `shared_ep_7_shrine`: 神社（ep_7）
- `shared_warabeuta`: 童歌ふたこじぞう

#### 背景画像（2026年2月8日対応完了）

scenarios.mdに追記された `> 🎨 [ファイル名]` 記法をJSONに反映しました。

**対応済みファイル**:
- `exploration.json`: house_front.jpg
- `day_1010_b_1.json`: sea_road.jpg（sea.jpgから修正）
- `day_1010_b_2.json`: ani_no_mizu.jpg（2箇所）
- `day_1010_b_3.json`: secret_base.jpg
- `day_1010_b_4.json`: busstop.jpg, underpass.jpg
- `day_1010_c_1.json`: waterway.jpg, sea_road.jpg
- `day_1010_d_1.json`: busstop2.jpg
- `day_1010_e_1.json`: busstop2.jpg
- `shared_ep_7_shrine.json`: retaining_wall.jpg

**未対応**: `> 🎨 [no image]` 指定箇所（背景なし = backgroundコマンドを出力しない）

### ❌ 未完成

#### シナリオ

- **10月12日**: 全体未執筆（クライマックス、最優先）

#### 実装

- **シナリオJSONへの変換**: ほぼ未実装
- **GDScriptの実装**: 基本的なシステムのみ

------

## 🚧 設計上の課題（要検討）

### シナリオ管理構造の問題

#### 現状の問題点

**1. dinnerが9箇所から呼び出されている**
- `days/day_1010/dinner.json`が全ルート共通なのに、各branchesファイルが個別に呼び出している
- 呼び出し箇所: day_1010_b_3.json, day_1010_b_4.json, day_1010_c_2.json, day_1010_d_2.json, day_1010_d_3.json, day_1010_e_2.json, day_1010_e_3.json, shared_ep_3_after.json, shared_ep_7_shrine.json
- 夜のフロー変更時、9箇所の修正が必要

**2. メインスレッドの概念が不明確**
```
main.json
  └─ exploration.json 呼び出し
      └─ 選択肢で各branchesにジャンプ（戻ってこない）
          └─ 各自がdinnerを呼び出し
```

**3. sharedの使い方が不統一**
- `shared_ep_3_after`: エピソード後の共通部分のみ（ep_03は呼び出し元が呼び出す）
- `shared_ep_7_shrine`: エピソード呼び出し（ep_07）を含む

#### 設計案

**案A: メインスレッド回帰方式** ⭐推奨

探索終了後、main.jsonに戻り、メインスレッドが夜のフローを管理する方式

```
main.json
  ├─ プロローグ〜実家（既存）
  ├─ exploration.json 呼び出し（load_scenarioで戻ってくる）
  ├─ dinner.json 呼び出し（1箇所のみ）
  ├─ evening_common.json 呼び出し
  ├─ evening_branch.json 呼び出し
  └─ 翌日へ
```

**メリット**:
- メインフローが一目瞭然
- dinner呼び出しが1箇所だけ（保守性向上）
- 夜のフロー変更が容易

**デメリット**:
- 各branchesが探索終了を通知する仕組みが必要
- GDScriptの実装が必要

**案B: 探索後共通フロー方式**

探索終了後の共通フローを`shared/after_exploration.json`に集約する方式

```
exploration.json
  └─ 選択肢（scenarioでジャンプ）
      └─ 各branches
          └─ shared/after_exploration.json にジャンプ

shared/after_exploration.json
  ├─ dinner 呼び出し（1箇所のみ）
  ├─ evening_common 呼び出し
  ├─ evening_branch 呼び出し
  └─ 翌日へ
```

**メリット**:
- dinner呼び出しが1箇所だけ（保守性向上）
- 各branchesのジャンプ先が明確

**デメリット**:
- メインスレッドの概念が曖昧
- after_explorationが実質的なメインになる

#### 検討時の確認事項

1. **GDScriptの`load_scenario`と`scenario`の仕様確認**
   - `load_scenario`: 呼び出し元に戻るのか？
   - `scenario`: ジャンプ（戻らない）なのか？
   - scripts/core/command_executor.gd と scenario_engine.gd を確認

2. **探索終了の判定方法**
   - 各branchesがどのように探索終了を通知するか
   - GDScriptで実装が必要か

3. **他の日付への影響**
   - 10月11日、10月12日も同様の構造か
   - 統一的な設計にすべきか

#### 決定事項（未定）

**TODO**: どちらの設計案を採用するか決定してください
- [ ] 案A（メインスレッド回帰方式）を採用
- [ ] 案B（探索後共通フロー方式）を採用
- [ ] 別の方式を検討

------

## 📋 作業の優先順位

### 最優先 ⭐⭐⭐

#### 1. 10月12日のシナリオ執筆

**重要度**: 最高 **理由**: クライマックスシーン。トゥルーエンド到達のために必須

**書くべき要素**:
- project_overview.mdの「10月12日の詳細設計（クライマックス）」セクション（行591-751）を参照
- キャッチボールエピソード（ep_4）の回収
- 手紙の発見 → 秘密基地への道 → 缶の掘り起こし
- 声を出そうとして出ない瞬間（主人公が声を失っていたことの明示）
- 霊体スグの最終出現
- エンディング分岐（トゥルー/ノーマル）

------

## ⚠️ 重要な注意事項

### やってはいけないこと 🚫

1. **シナリオの内容を変更しない**
   - scenarios.mdの内容が正です
   - JSONはscenarios.mdを忠実に変換したものでなければなりません
2. **記法やコマンドの仕様を独自に変更しない**
   - `project_overview.md` の「シナリオJSON記法」セクションを参照
   - 変更が必要な場合は必ず相談してください
3. **GDScriptの大幅な書き換えをしない**
   - 動作を変えない範囲での整理のみ
   - バグ修正以外の機能追加は相談してください
4. **ドキュメントを読まずに作業しない**
   - 必ず `project_overview.md` を先に読んでください

### やるべきこと ✅

1. **コメントは日本語で**
   - 既存の英語コメントも日本語に変換してください
2. **命名規則の統一**
   - project_overview.mdのファイル命名規則に従ってください
3. **不要なコードの削除**
   - 試行錯誤で残った使われていないコードは削除してください
4. **わからないことは質問**
   - 判断に迷ったら必ず報告・相談してください

------

## 📖 ゲームの核心（ネタバレ注意）

このゲームには4つの大きなミスリードがあります：

1. **主人公は声を失っている**
   - プレイヤーには最後まで明かされない
   - 「伝えた」「応えた」という表現で誤認させる
2. **「キミノコエ」のダブルミーニング**
   - 「君の声」= 弟スグの声
   - 「君の声」= 主人公自身の失われた声
3. **2人の白い服の少年**
   - 実在する少年（イロの友人の子供）
   - スグの霊体（本物の弟）
4. **記憶の混濁**
   - ep_0は歪んだ記憶（喧嘩したまま事故へ）
   - ep_0_βが真実（仲直りしていた）

これらの設定を理解した上で、シナリオを扱ってください。

------

## 📝 シナリオの記法ルール（重要）

### 主人公の声について

- **主人公は声を出してはいけない**（現在時点）
- **過去のエピソード内では声を出してOK**
- **手話を知っている人との会話**では「伝えた」「応えた」と書く（ミスリード）
- **霊体を出すかどうか**は意図的に使い分けられています
  - 霊体あり: ep_1, ep_2, ep_3
  - 霊体なし: ep_4, ep_5, ep_6, ep_7

### エピソード後の描写

- エピソード終了後は必ず「……。…………。………………。」で始まる
- 霊体ありエピソードの後に霊体描写を入れる
- 霊体なしエピソードは温かい余韻で終わる

------

## 🎯 最終目標

### 短期目標（体験版） - 完了 ✅

- ✅ 10月10日の探索ルート完成
- ✅ 夕食シーン完成
- ✅ 体験版エンディング完成

**体験版として必要なシナリオはすべて完成しました！**

### 中期目標（完成版）

- ⏳ 10月12日（クライマックス）完成
- ⏳ トゥルーエンディング完成
- ⏳ シナリオのJSON変換
- ⏳ GDScriptの実装・統合

### 長期目標

- マル秘ストーリー（イロが主人公）
- マルチシナリオ（ホラー要素）

------

## 💬 質問・相談について

わからないことや判断に迷うことがあれば、遠慮なく質問してください。

特に以下の点は必ず相談してください：

- ファイルの大規模な削除や変更
- GDScriptの動作変更
- シナリオの内容に関わる変更
- 記法やコマンドの仕様変更

------

## 📝 作業開始前チェックリスト

作業開始前に以下を確認してください：

- [ ] `project_overview.md` を読んだ
- [ ] `scenarios.md` の構造を理解した
- [ ] ゲームの4つのミスリードを理解した
- [ ] ファイル命名規則を理解した
- [ ] シナリオJSON記法を理解した
- [ ] やってはいけないことを確認した

------

## 🎉 最後に

このゲームは感動的なストーリーを持つ丁寧な作品です。 ぜひ内容を理解した上で、丁寧に作業してください。

よろしくお願いします！