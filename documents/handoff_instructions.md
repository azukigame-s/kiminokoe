# Claude Code 引継ぎ指示文

## 📚 まず読んでください

このプロジェクトは「キミノコエ」という感動系ビジュアルノベルゲームです。
以下のドキュメントを順番に読んでから作業を開始してください。

### 必読ドキュメント（優先順）

1. **`documents/project_overview.md`**
   - ゲーム全体の仕様書
   - ストーリー、キャラクター、技術仕様が全て記載されています
   - **最重要**: これを読まずに作業しないでください

2. **`documents/scenarios.md`**
   - シナリオの原稿（マークダウン形式）
   - JSON変換前のマスターデータです
   - シナリオの内容確認はこちらを参照してください

3. **このディレクトリの構造**
   ```
   kiminokoe/
   ├── documents/              # ドキュメント（上記2ファイル）
   ├── assets/                 # リソースファイル
   ├── scenarios/              # シナリオJSON
   ├── scenes/                 # Godotシーン
   ├── scripts/                # GDScript
   └── project.godot           # Godotプロジェクトファイル
   ```

---

## 🎯 プロジェクトの現状

### 完成している部分 ✅

#### シナリオ（scenarios.md）
- **プロローグ**: 完成
- **10月10日 北ルート**: ほぼ完成
  - 北→北東（岩場）→ep_5「捨て猫」
  - 北→北東→南 → ep_3「バス停」+ shared_ep_3_after
  - 北→北西（海水浴場）→ shared_day_1010_c → ep_2「海」
- **10月10日 東ルート**: 95%完成
  - ep_6「沢蟹」+ 童歌
  - 北 → ep_3「バス停」+ shared_ep_3_after
  - 南 → ep_7「神社」
  - **未配置**: 西への分岐
- **10月11日**: 完成（法事シーン）
- **エピソード**: ep_0〜ep_7 すべて完成

#### 共用シナリオ（shared）
- `shared_day_1010_c`: 海水浴場（ep_2 + 霊体描写）
- `shared_ep_3_after`: バス停の後（霊体描写 + イロが迎えに来る）

### 未完成の部分 ⚠️

#### シナリオ
- **10月10日 南ルート**: 1枠目のイベント + 2枠目の展開
- **10月10日 西ルート**: 1枠目のイベント + 2枠目の展開
- **10月10日 夕食シーン**: 未執筆
- **10月10日 体験版エンディング**: 未執筆
- **10月12日**: 全体未執筆（クライマックス）
- **未配置の2枠目パターン**: 東→西、南→東、南→西、西→東

#### 実装
- **シナリオJSONへの変換**: ほぼ未実装
- **GDScriptの実装**: 基本的なシステムのみ

---

## 🔧 現在の課題と対応方針

### 課題1: シナリオJSONの整備

#### 現状
- scenarios.mdは最新だが、JSONへの変換が追いついていない
- ファイル命名規則が不統一
- 選択肢の記法が2種類混在

#### 対応方針
**ファイル命名規則の統一**（project_overview.md参照）

```
scenarios/
├── main.json                          # エントリーポイント
├── days/
│   ├── day_1010_main.json             # 10月10日メイン（バス到着〜自由時間開始）
│   ├── day_1010_b_1.json              # 10月10日 北（海の入口）
│   ├── day_1010_b_2.json              # 10月10日 東（湧き水）
│   ├── day_1010_b_3.json              # 10月10日 南（お寺）
│   ├── day_1010_b_4.json              # 10月10日 西（バス停方面）
│   ├── day_1010_c_1.json              # 10月10日 北東（岩場）
│   ├── day_1010_d_1.json              # 10月10日 北東→南（バス停）
│   ├── day_1010_d_2.json              # 10月10日 北東→西（海水浴場へ）
│   ├── day_1010_e_1.json              # 10月10日 東→北（バス停）
│   ├── day_1010_e_2.json              # 10月10日 東→南（神社）
│   ├── day_1011_main.json             # 10月11日メイン
│   └── day_1012_main.json             # 10月12日メイン（未完成）
├── shared/                            # 共用シナリオ
│   ├── shared_day_1010_c.json         # 海水浴場（ep_2 + 霊体）
│   └── shared_ep_3_after.json         # バス停の後（霊体 + イロ迎え）
└── episodes/
    ├── ep_00.json                     # 命日（喧嘩バージョン）
    ├── ep_00_beta.json                # 命日（仲良しバージョン）
    ├── ep_01.json                     # カード
    ├── ep_02.json                     # 海
    ├── ep_03.json                     # バス停
    ├── ep_04.json                     # キャッチボール
    ├── ep_05.json                     # 捨て猫
    ├── ep_06.json                     # 沢蟹
    └── ep_07.json                     # 神社
```

**選択肢ID → ファイル名の対応**:
- `opt_day_1010_b_1` → `day_1010_b_1.json`
- `opt_day_1010_c_2` → `shared_day_1010_c.json` （共用シナリオは例外）

### 課題2: 記法の統一

#### 選択肢の記法
- **同一ファイル内のジャンプ**: `next_index` を使用
- **別ファイルへの遷移**: `scenario` を使用
- これは意図的な設計です（変更不要）

#### エピソード呼び出し
```json
{"type": "load_scenario", "path": "episodes/ep_01"}
```
- グレースケールに切り替わる
- 呼び出し後は元のシナリオに戻る

#### 共用シナリオ呼び出し
```json
{"type": "load_scenario", "path": "shared/shared_day_1010_c"}
```
- グレースケールにはならない（現在時点のシーンのため）
- 呼び出し後は元のシナリオに戻る

### 課題3: main.jsonの修正

#### 確認済みの誤字・脱字
1. `"弟の法事は明日の午後から予定されいている。"` → `"されている"`

#### 未追加の描写
1. **地下道の少年の描写**（より詳細に）
   - 修正前: 「肌が白く」
   - 修正後: 「真っ白な服を着て少しカールした黒髪の」

2. **記憶の混濁の描写** ※詳細はproject_overview.md参照
   - 梨のシーン: 「スグはこの梨が好きだっただろうか？――思い出せない」
   - 地下道: 「白い服の少年――どこかで見たような気がする。でも、思い出せなかった」

### 課題4: スキップモード復帰時の動作改善（未対応）

#### 現状の問題
エピソードやsharedシナリオからの復帰時、スキップモードが一時停止してしまう問題があります。

**具体的な症状**:
- エピソード（`episodes/ep_00.json`など）から`main.json`に復帰した際
- Sharedシナリオ（`shared/shared_ep_3_after.json`など）から元のシナリオに復帰した際
- スキップモードが継続せず、ユーザーが一度クリックする必要がある

#### 暫定対応（実施済み）
復帰後の最初のテキストは手動クリックが必要という仕様を受け入れ、それ以降はスキップモードが継続する実装としています。

**理由**:
- 動作が安全で確実
- 他の機能に影響を与えない
- プレイヤー体験上、大きな問題ではない（一度のクリックのみ）

#### 根本的な解決（推奨・未実装）

スキップモードの実装全体を見直し、シナリオスタックとの連携を改善することで、復帰後も自動進行が継続するようにします。

**必要な作業**:

1. **`_process()`と`execute_current_command()`の役割整理**
   - 現状: `_process()`がスキップモード中の自動進行を担当
   - 問題: 復帰直後は`_process()`が動作するタイミングが不安定
   - 対応: スキップモードの自動進行ロジックを一元化し、復帰時も確実に動作するようにする

2. **シナリオ復帰時の状態管理を明確化**
   - 現状: `_return_to_previous_scenario()`で復帰後、`execute_current_command()`を呼ぶ
   - 問題: `waiting_for_click`や`is_text_completed`の状態が不整合になる
   - 対応: 復帰時の状態を明確に定義し、スキップモード中の処理フローを統一

3. **dialogue コマンドの処理見直し**
   - 現状: スキップモード中は`complete_text_display()`を呼ぶが、自動進行は`_process()`に依存
   - 問題: 復帰直後は`_process()`が動作しないタイミングがある
   - 対応: `dialogue`コマンド自体でスキップモード時の完全な処理を行う、または復帰時専用の処理を追加

**技術的な詳細**:

参照ファイル:
- `scripts/scenario.gd` - シナリオ管理とスタック処理
  - `_return_to_previous_scenario()` (413-446行): 復帰処理
  - `execute_current_command()` (146-305行): コマンド実行
  - `_process()` (314-336行): スキップモード自動進行
  - `dialogue`コマンド処理 (165-189行): テキスト表示
- `scripts/novel_system.gd` - テキスト表示とスキップモード管理
  - `is_skip_mode`: スキップモードフラグ
  - `complete_text_display()`: テキスト即時完了
  - `is_text_completed`: テキスト完了フラグ

**提案する修正方針**:

**案A: `dialogue`コマンドでスキップモード時に自動進行**
```gdscript
# dialogueコマンド処理内で
if novel_system.is_skip_mode:
    novel_system.complete_text_display()
    # バッファ処理も含めた完全な自動進行
    call_deferred("_handle_skip_mode_auto_advance")
```

**案B: 復帰時専用の処理を追加**
```gdscript
func _return_to_previous_scenario():
    # ... 既存の処理 ...
    execute_current_command()
    
    # スキップモード中の復帰時は特別処理
    if novel_system.is_skip_mode:
        _ensure_skip_mode_continues()
```

**案C: `_process()`を常に確実に動作させる**
```gdscript
# 復帰時にフレーム待機を確実に入れる
func _return_to_previous_scenario():
    # ... 既存の処理 ...
    execute_current_command()
    await get_tree().process_frame  # 1フレーム待機
    # この時点で_process()が動作し、自動進行が開始される
```

#### テスト項目

修正後は以下のケースでスキップモードが継続することを確認:
1. `main.json` → `episodes/ep_00.json` → `main.json` 復帰
2. `main.json` → `shared/shared_ep_3_after.json` → `main.json` 復帰
3. 複数のエピソードを連続でスキップ
4. エピソード内でもスキップモードが正常動作
5. 選択肢でスキップモードが停止
6. 通常進行（スキップなし）に影響がないこと

#### 優先度

**中**: プレイヤー体験の向上のため実装推奨ですが、ゲームの進行自体は問題なく動作します。

---

## 📋 作業の進め方

### Step 1: 現状把握（必須）

以下を実施してください：

1. **ドキュメントの熟読**
   - [ ] `project_overview.md` を読む
   - [ ] `scenarios.md` を読む（少なくとも構造を理解する）

2. **既存ファイルの確認**
   - [ ] `scenarios/` 配下の全JSONファイルをリストアップ
   - [ ] `scripts/` 配下の全GDScriptをリストアップ
   - [ ] ファイル命名の不整合を特定
   - [ ] 不要なファイルを特定

3. **コードレビュー**
   - [ ] GDScriptを読んで、試行錯誤で複雑になった箇所を特定
   - [ ] 不要なコードを特定
   - [ ] コメントが英語の箇所を特定

### Step 2: 整理計画の報告（必須）

以下の形式で報告してください：

```markdown
## 整理計画

### ファイル名変更
- `old_name.json` → `new_name.json`（理由: xxx）

### ファイル削除
- `unused_file.json`（理由: xxx）

### コード変更
- `script_name.gd` の xxx 部分を簡略化（理由: xxx）

### 誤字・脱字修正
- main.json の xxx を修正

### 未追加描写の追加
- main.json に記憶の混濁の描写を追加
```

**⚠️ 重要**: 実行前に必ず報告して、確認を求めてください。

### Step 3: 実行

確認後、以下の順序で実施してください：

1. **バックアップの作成**（推奨）
2. **ファイル名の変更**
3. **不要ファイルの削除**
4. **コードの整理**
5. **誤字・脱字の修正**
6. **未追加描写の追加**
7. **動作確認**

---

## ⚠️ 重要な注意事項

### やってはいけないこと 🚫

1. **シナリオの内容を変更しない**
   - scenarios.mdの内容が正です
   - JSONはscenarios.mdを忠実に変換したものでなければなりません

2. **記法やコマンドの仕様を独自に変更しない**
   - `project_overview.md` の「シナリオJSON記法」セクションを参照
   - 変更が必要な場合は必ず相談してください

3. **GDScriptの大幅な書き換えをしない**
   - 動作を変えない範囲での整理のみ
   - バグ修正以外の機能追加は相談してください

4. **ドキュメントを読まずに作業しない**
   - 必ず `project_overview.md` を先に読んでください

### やるべきこと ✅

1. **コメントは日本語で**
   - 既存の英語コメントも日本語に変換してください

2. **命名規則の統一**
   - 上記のファイル命名規則に従ってください

3. **不要なコードの削除**
   - 試行錯誤で残った使われていないコードは削除してください

4. **わからないことは質問**
   - 判断に迷ったら必ず報告・相談してください

---

## 📖 参考情報

### ゲームの核心（ネタバレ注意）

このゲームには3つの大きなミスリードがあります：

1. **主人公は声を失っている**
   - プレイヤーには最後まで明かされない
   - 「伝えた」「応えた」という表現で誤認させる

2. **「キミノコエ」のダブルミーニング**
   - 「君の声」= 弟スグの声
   - 「君の声」= 主人公自身の失われた声

3. **2人の白い服の少年**
   - 実在する少年（イロの友人の子供）
   - スグの霊体（本物の弟）

これらの設定を理解した上で、シナリオを扱ってください。

### シナリオの記法ルール（重要）

- **主人公は声を出してはいけない**（現在時点）
- **過去のエピソード内では声を出してOK**
- **手話を知っている人との会話**では「伝えた」「応えた」と書く（ミスリード）
- **霊体を出すかどうか**は意図的に使い分けられています
  - 霊体あり: ep_1, ep_2, ep_3
  - 霊体なし: ep_4, ep_5, ep_6, ep_7

### GDScriptで実装すべき機能

1. **グレースケール切り替え**
   - エピソード（過去の回想）: グレースケール
   - 共用シナリオ（現在時点）: 通常カラー

2. **エピソード後の「……」**
   - エピソード終了後は必ず「……。…………。………………。」で始まる

3. **霊体の描写**
   - 霊体ありエピソードの後に表示
   - 半透明、ぼんやり、輪郭が曖昧

4. **選択肢の分岐管理**
   - `next_index` と `scenario` の使い分け
   - エピソード回収率の管理

---

## 🎯 最終目標

### 短期目標（体験版）
- 10月10日の全ルート完成
- 夕食シーン完成
- 体験版エンディング完成

### 中期目標（完成版）
- 10月12日（クライマックス）完成
- トゥルーエンディング完成

### 長期目標
- マル秘ストーリー（イロが主人公）
- マルチシナリオ（ホラー要素）

---

## 💬 質問・相談について

わからないことや判断に迷うことがあれば、遠慮なく質問してください。

特に以下の点は必ず相談してください：
- ファイルの大規模な削除や変更
- GDScriptの動作変更
- シナリオの内容に関わる変更
- 記法やコマンドの仕様変更

---

## 📝 チェックリスト

作業開始前に以下を確認してください：

- [ ] `project_overview.md` を読んだ
- [ ] `scenarios.md` の構造を理解した
- [ ] ゲームの3つのミスリードを理解した
- [ ] ファイル命名規則を理解した
- [ ] シナリオJSON記法を理解した
- [ ] やってはいけないことを確認した

---

## 🎉 最後に

このゲームは感動的なストーリーを持つ丁寧な作品です。
ぜひ内容を理解した上で、丁寧に整理してください。

よろしくお願いします！