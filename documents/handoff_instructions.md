# Claude Code 引継ぎ指示文

## まず読んでください

このプロジェクトは「キミノコエ」という感動系ビジュアルノベルゲームです。

以下のドキュメントを順番に読んでから作業を開始してください。

### 必読ドキュメント（優先順）

1. **`project_overview.md`**
   - ゲーム全体の仕様書
   - ストーリー、キャラクター、技術仕様が全て記載されています
   - **最重要**: これを読まずに作業しないでください
2. **`scenarios.md`**
   - シナリオの原稿（マークダウン形式）
   - JSON変換前のマスターデータです
   - シナリオの内容確認はこちらを参照してください

------

## 現在の作業状況（2026年2月23日時点）

### 完成済み

#### シナリオ（scenarios.md）

- **プロローグ**: 完成
- **10月10日**: 完成
  - 1枠目: 北・東・南・西すべて完成
  - 2枠目: すべて完成
  - 地蔵の配置: 完了（各ルートに配置済み）
  - **夕食シーン（19:00）**: 完成
  - **体験版エンディング（21:00〜22:00）**: 完成
- **10月11日**: 完成（法事シーン）
- **エピソード**: ep_0, ep_0_β, ep_1〜ep_7 すべて完成

#### 共用シナリオ（shared）

- `shared_day_1010_c`: 海水浴場（ep_2 + 霊体描写）
- `shared_ep_3_after`: バス停の後（霊体描写 + イロが迎えに来る）
- `shared_ep_7_shrine`: 神社（ep_7）
- `shared_warabeuta`: 童歌ふたこじぞう

#### 背景画像

scenarios.mdに追記された `> 🎨 [ファイル名]` 記法をJSONに反映済み。

#### GDScript実装

- **ScenarioEngine移行**: 完了（旧 novel_system.gd → 新 ScenarioEngine）
- **Step 7a: UI統一**: 完了（UIConstants, UIStyleHelper, PauseMenu, BottomMenu）
- **Step 7b: 足跡（バックログ）**: 完了（BacklogDisplay, BacklogManager, 和風デザイン）
- **Step 7c: トロフィー（軌跡）画面**: 完了（trophy_screen.gd, TrophyManager）
- **タイトル画面改修**: 完了（「ゲームを始める」ボタンに統合）
- **セーブ情報画面**: 完了（save_info_scene.gd — つづきから/はじめから/データリセット）
- **プレイ時間計測**: 完了（game_scene.gd で計測、オートセーブに含む）
- **設定画面**: 完了（和風テーマ統一、テキスト速度5段階スライダー、起動時自動適用）
- **セーブ機能**: 完了（ワンセーブデータ方式 — 周回前提のためマルチスロット不要。オートセーブ + セーブ情報画面で完結）
- **起動時スプラッシュ画面**: 完了（splash_scene.gd — ロゴ動画再生 → クロスフェード → フィクション表記 → タイトル）
- **体験版エンディング画面**: 完了（game_scene.gd — お礼メッセージ + 軌跡進捗表示 + タイトルへもどるボタン）
- **体験版専用トロフィー**: 完了（「地蔵焚の旅人」— ep6種 + シークレット3種 + プレイ時間3h以上で解除）
- **トロフィートースト**: 完了（和風テーマ + trophy.jpg紙テクスチャアイコン）
- **セーブデータの部分クリア**: 完了（体験版ED後はシナリオ進行のみクリア、名前・プレイ時間・軌跡は保持）
- **AudioManager BGM継続**: 完了（`process_mode = PROCESS_MODE_ALWAYS` により、一息・足跡・設定画面中もBGMが継続再生される）
- **タイトル画面演出**: 完了（波ゆらぎシェーダー `water_wave.gdshader` + 波紋オーバーレイ `ripple_overlay.gd` + BGMフェードインと同期した墨色→タイトルのフェードイン）
- **起動設定**: 完了（ブートスプラッシュ削除 `boot_splash/show_image=false`、ウィンドウタイトル「キミノコエ」、`logo.ico` によるWindowsアイコン設定）
- **サブタイトル改修**: 完了（2行統一フォーマット `"１０月１０日\n　１５：３０"` 形式、`next_background` パラメータでフェードアウト開始時に背景を即時切替）
- **全フェード色統一**: 完了（SceneManagerフェード・タイトルオーバーレイを `UIConstants.COLOR_BASE_DARK`（墨色）に統一）
- **名前入力画面**: 完了（Escキーヒント表示から `UIStyleHelper.style_back_button` による「もどる」ボタンに変更）
- **設定画面スライダー幅統一**: 完了（テキスト速度・マスター音量の値ラベル幅を 120px に統一、スライダーが等幅になった）
- **童歌フルスクリーン表示（PoemDisplay）**: 完了（`scripts/ui/poem_display.gd`、layer=55、1行ずつフェードイン＋クリック待機）
- **BGM配置（全シーン）**: 完了（全シーンにBGMを配置済み。詳細は下記「BGM計画」を参照）
- **BGMエイリアスシステム**: 完了（`AudioManager.bgm_aliases` 辞書にパスを一元集約し、JSONからはエイリアス名（`"main"`, `"flashback"` 等）で指定する方式に移行。14ファイル・20箇所を移行済み）
- **スプラッシュ画面クリックフリーズ修正**: 完了（`VideoStreamPlayer.stop()` がGodot4では `finished` を発火しない問題を `signal _advance_requested` パターンで解決）
- **体験版EDトロフィー数修正**: 完了（`ep_4`（キャッチボール）が製品版限定であるため `demo_episode_ids` を分離、合計11個に修正）

#### セーブデータ仕様

- **保存場所**: `user://save_data.cfg`（ConfigFile形式）
- **保存項目**: protagonist_name, scenario_path, index, stack, background_path, bgm_path, effect, backlog, play_time
- **`clear_save_data()`**: ファイル全体を削除（データリセット用）
- **`clear_scenario_progress()`**: シナリオ関連キーのみ削除、protagonist_name と play_time は保持（体験版ED用）
- **`can_continue()`**: セーブファイルが存在し、かつ scenario_path が空でない場合に true
- **セーブ情報画面の表示**:
  - `can_continue() == true`: 「つづきからはじめる」活性 +「はじめからはじめる」（確認ダイアログあり）
  - `has_save_data() == true` かつ `can_continue() == false`: 「つづきからはじめる」非活性（グレー表示）+「はじめからはじめる」（確認なしで直接開始）
  - `has_save_data() == false`: 「はじめる」のみ表示

### 未完成

#### シナリオ

- **10月12日**: 全体未執筆（クライマックス、最優先）

#### 実装

なし

------

## 体験版リリース タスク一覧

### 完了済みタスク

- ~~**A1**: インジケーター種別の不一致~~ — シナリオJSONの go_next フラグを修正済み
- ~~**A2**: 背景画像の切り替え不具合~~ — day_1010_e_2.json を load_scenario に修正済み
- ~~**A3**: 一息→設定の遷移不具合~~ — 修正済み
- ~~**A4**: もどるボタンの初期フォーカス色~~ — 修正済み
- ~~**B1+B2**: 起動時ロゴ表示 + フィクション表記~~ — splash_scene.gd 実装済み
- ~~**B3**: 体験版END後のタイトルへの導線~~ — 体験版ED画面実装済み
- ~~トロフィートーストのデザイン統一~~ — 和風テーマ + trophy.jpgアイコン
- ~~体験版専用トロフィー追加~~ — 「地蔵焚の旅人」
- ~~BGM配置（タイトル・探索後）~~ — 悠久の彼方.mp3（タイトル）、忘却の都.mp3（探索後フェーズ）実装済み
- ~~BGM配置（全シーン）~~ — 夕食・夜・回想・不穏・ep_00 すべて配置済み（BGMエイリアスシステムで実現）
- ~~BGMエイリアスシステム~~ — AudioManager.bgm_aliases に一元管理、JSONは名前で指定
- ~~スプラッシュ画面クリックフリーズ~~ — signal _advance_requested パターンで修正済み
- ~~体験版EDトロフィー数（12→11）~~ — demo_episode_ids 分離で修正済み
- ~~テストケース全件（TC-001〜TC-012, TC-101, TC-102, TC-201, TC-202）~~ — 全ケース通過・全不具合修正済み（test_cases.md 参照）

### 残りタスク

なし（体験版リリース可能な状態）

------

## BGM計画

### BGM一覧（エイリアス別）

BGMの変更は `scripts/ui/audio_manager.gd` の `bgm_aliases` 辞書1箇所のみを編集する。

| # | エイリアス | 決定曲 | 雰囲気 | 使用箇所 | 状態 |
|---|-----------|--------|--------|---------|------|
| 1 | `title`    | **悠久の彼方.mp3** | ノスタルジック、儚い、神秘的 | タイトル画面 | ✅ 実装済み |
| 2 | `main`     | **忘却の都.mp3** | リュート、望郷 | バス到着〜イロ再会、探索フェーズ | ✅ 実装済み |
| 3 | `dinner`   | **Old_home.mp3** | アコギ、牧歌的、温かい | 19:00 夕食シーン | ✅ 実装済み |
| 4 | `night`    | **冬待人.mp3** | ピアノソロ、しっとり | 21:00〜就寝 | ✅ 実装済み |
| 5 | `flashback`| **Ancient_Travelers.mp3** | ハープ、民族音楽風、切ない+温かい | ep_01〜ep_07のフラッシュバック | ✅ 実装済み |
| 6 | `autumn`   | **秋の想い出.mp3** | ピアノ、静か | ep_00（命日プロローグ回想） | ✅ 実装済み |
| 7 | `suspense` | **悲しい記憶.mp3**（別作曲者） | ピアノ+効果音、不安、シンプル | 焚き場シーン | ✅ 実装済み |
| 8 | —          | 未定 | 子供の声や単純な旋律、不気味さ | shared_warabeuta（PoemDisplay） | 未配置 |

**候補曲（未使用・差し替え時に検討）:**
- `桜花の記憶.mp3` — 夜の代替候補
- `朝霧の守り.mp3` — 夕食の代替候補

**備考:**
- 焚き場の演出方針: `main` → BGM停止（`"name": "stop"`）→ 核心で `suspense` を控えめに導入
- 候補曲は同一作曲者（DOVA-SYNDROME）で統一感を重視。不穏系のみ別作曲者

**課題:**
- メインテーマ（忘却の都）が暗すぎる/民族音楽調が強すぎる可能性あり → 要再検討
- 童歌BGMが未設定 → 無音のままか専用曲を入れるか検討

### 切り替えタイミング（時系列）

| タイミング | BGMエイリアス | 切り替え方法 |
|-----------|-------------|-------------|
| タイトル画面 | `title` | — |
| バス→到着 | `main` | フェードイン |
| ep_00（事故回想直前） | `autumn` | クロスフェード |
| ep_00終了→イロ再会 | `main` | フェードイン |
| 探索開始（16:00） | `main` 継続 | — |
| エピソード突入時 | `flashback` | クロスフェード |
| エピソード終了→探索復帰 | `main` | フェードイン |
| 夕食（19:00） | `dinner` | クロスフェード |
| 焚き場（不穏） | `stop` → `suspense` | フェードアウト→フェードイン |
| 寝室（21:00） | `night` | クロスフェード |
| 眠りに落ちる | `stop` | フェードアウト |

### 優先度

- **必須（4曲）**: メインテーマ、回想、不穏、夜
- **追加（2曲）**: 夕食、童歌
- **検討**: トラウマ（無音でも可）

### SE計画

#### 環境音（ループ系）

| SE | 使用場面 | 効果 | 優先度 |
|----|---------|------|--------|
| 波の音 | 海の背景シーン（バス停、海水浴場、岩場） | 海辺の臨場感 | 高 |
| 虫の声（秋の虫） | 夕方〜夜の屋外、寝室 | 10月の田舎の空気感 | 高 |
| 風の音 | 高台の空き地、焚き場、神社 | 寂しさ・不穏さ | 中 |
| 雨音 | 焚き場からの帰り道、バス停小屋 | 天候の変化 | 中 |
| 川・沢の音 | 湧き水（東ルート）、兄の水 | 清涼感 | 中 |

#### ワンショット系

| SE | 使用場面 | 効果 | 優先度 |
|----|---------|------|--------|
| バスのドア・発車音 | プロローグ冒頭、バス降車時 | 場面の切り替わり | 高 |
| 鳥の声（トンビ） | 海沿いの屋外シーン | 田舎の海辺らしさ | 中 |
| 御札のカラカラ音 | 焚き場のロープに吊るされた御札 | シナリオで直接言及あり | 高 |
| 柄杓で水を汲む音 | お寺の湧水 | 情景描写の補強 | 低 |
| 食器の音 | 夕食シーン | 家族団らんの生活感 | 低 |
| 時計の音 | 寝室で一人の夜 | 静けさの強調 | 低 |
| 雷（遠雷） | 焚き場→帰宅前 | 雨の前触れ、不穏さ | 中 |

**備考:**
- 環境音はループ再生のため、現在の sfx コマンド（ワンショット再生）とは別の仕組みが必要になる可能性あり
- まず高優先度のものから素材を探して配置し、効果を確認する

### 将来タスク（体験版後）

#### 10月12日のシナリオ執筆

**重要度**: 最高 **理由**: クライマックスシーン。トゥルーエンド到達のために必須

**書くべき要素**:
- project_overview.mdの「10月12日の詳細設計（クライマックス）」セクションを参照
- キャッチボールエピソード（ep_4）の回収
- 手紙の発見 → 秘密基地への道 → 缶の掘り起こし
- 声を出そうとして出ない瞬間（主人公が声を失っていたことの明示）
- 霊体スグの最終出現
- エンディング分岐（トゥルー/ノーマル）

#### ゲーム内設定画面の子ノード化

- **現状**: ゲーム→一息→設定は別シーンへの遷移のため、オートセーブ→復元が必要
- **方針**: 設定画面をゲームシーンの子ノード（CanvasLayer）として持ち、シーン遷移を不要にする
- **メリット**: オートセーブ・復元が不要、遷移が瞬時、ゲーム状態が完全保持
- **注意**: タイトル画面用とゲーム内用で設定画面の共通コンポーネント化が必要

#### シナリオ管理構造のリファクタリング

- **方針**: 案A（メインスレッド回帰方式）を採用予定
- **内容**: exploration 終了後に main.json に戻り、dinner を1箇所から呼ぶ構造に変更
- **詳細**: handoff_instructions.md の旧「設計上の課題」セクションを参照（削除済みのため Git 履歴から確認）

------

## 重要な注意事項

### やってはいけないこと

1. **シナリオの内容を変更しない**
   - scenarios.mdの内容が正です
   - JSONはscenarios.mdを忠実に変換したものでなければなりません
2. **記法やコマンドの仕様を独自に変更しない**
   - `project_overview.md` の「シナリオJSON記法」セクションを参照
   - 変更が必要な場合は必ず相談してください
3. **GDScriptの大幅な書き換えをしない**
   - 動作を変えない範囲での整理のみ
   - バグ修正以外の機能追加は相談してください
4. **ドキュメントを読まずに作業しない**
   - 必ず `project_overview.md` を先に読んでください

### やるべきこと

1. **コメントは日本語で**
   - 既存の英語コメントも日本語に変換してください
2. **命名規則の統一**
   - project_overview.mdのファイル命名規則に従ってください
3. **不要なコードの削除**
   - 試行錯誤で残った使われていないコードは削除してください
4. **わからないことは質問**
   - 判断に迷ったら必ず報告・相談してください

------

## ゲームの核心（ネタバレ注意）

このゲームには4つの大きなミスリードがあります：

1. **主人公は声を失っている**
   - プレイヤーには最後まで明かされない
   - 「伝えた」「応えた」という表現で誤認させる
2. **「キミノコエ」のダブルミーニング**
   - 「君の声」= 弟スグの声
   - 「君の声」= 主人公自身の失われた声
3. **2人の白い服の少年**
   - 実在する少年（イロの友人の子供）
   - スグの霊体（本物の弟）
4. **記憶の混濁**
   - ep_0は歪んだ記憶（喧嘩したまま事故へ）
   - ep_0_βが真実（仲直りしていた）

これらの設定を理解した上で、シナリオを扱ってください。

------

## シナリオの記法ルール（重要）

### 主人公の声について

- **主人公は声を出してはいけない**（現在時点）
- **過去のエピソード内では声を出してOK**
- **手話を知っている人との会話**では「伝えた」「応えた」と書く（ミスリード）
- **霊体を出すかどうか**は意図的に使い分けられています
  - 霊体あり: ep_1, ep_2, ep_3
  - 霊体なし: ep_4, ep_5, ep_6, ep_7

### エピソード後の描写

- エピソード終了後は必ず「……。…………。………………。」で始まる
- 霊体ありエピソードの後に霊体描写を入れる
- 霊体なしエピソードは温かい余韻で終わる

------

## 最終目標

### 短期目標（体験版） - 完了

- 10月10日の探索ルート完成
- 夕食シーン完成
- 体験版エンディング完成

### 中期目標（完成版）

- 10月12日（クライマックス）完成
- トゥルーエンディング完成
- シナリオのJSON変換

### 長期目標

- マル秘ストーリー（イロが主人公）
- マルチシナリオ（ホラー要素）

------

## 質問・相談について

わからないことや判断に迷うことがあれば、遠慮なく質問してください。

特に以下の点は必ず相談してください：

- ファイルの大規模な削除や変更
- GDScriptの動作変更
- シナリオの内容に関わる変更
- 記法やコマンドの仕様変更

------

## 作業開始前チェックリスト

作業開始前に以下を確認してください：

- [ ] `project_overview.md` を読んだ
- [ ] `scenarios.md` の構造を理解した
- [ ] ゲームの4つのミスリードを理解した
- [ ] ファイル命名規則を理解した
- [ ] シナリオJSON記法を理解した
- [ ] やってはいけないことを確認した
